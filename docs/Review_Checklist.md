# OmniFluids MHD5F ä»£ç å®¡æŸ¥æ¸…å•

> é€æ–‡ä»¶ã€é€æ¨¡å—å¼•å¯¼æ£€æŸ¥æ‰€æœ‰æ”¹åŠ¨ã€‚æ¯é¡¹æ ‡æ³¨ã€é£é™©ç­‰çº§ã€‘ï¼šğŸ”´é«˜ / ğŸŸ¡ä¸­ / ğŸŸ¢ä½
> æ£€æŸ¥æ—¶è¯·å¯¹ç…§åŸå§‹ `nse2d_old/` ä»£ç ï¼Œç¡®è®¤æ”¹åŠ¨æ„å›¾ä¸å®ç°ä¸€è‡´ã€‚

---

## æ–‡ä»¶æ€»è§ˆ

| æ–‡ä»¶ | ä¸»è¦æ”¹åŠ¨ | çŠ¶æ€ |
|------|---------|------|
| `model.py` | æ•´ä½“é‡å†™ï¼šDST-xã€5åœºè¾“å‡ºå¤´ã€MoEé€‚é… | éœ€é€é¡¹ç¡®è®¤ |
| `psm_loss.py` | æ›¿æ¢ä¸º mhd_sim RHS æ—¶é—´å·®åˆ†æŸå¤± | éœ€é€é¡¹ç¡®è®¤ |
| `tools.py` | æ–°å¢æ•°æ®åŠ è½½å‡½æ•° | éœ€é€é¡¹ç¡®è®¤ |
| `train.py` | è®­ç»ƒå¾ªç¯ã€è¯„ä¼°ã€å¯è§†åŒ–å…¨éƒ¨é‡å†™ | éœ€é€é¡¹ç¡®è®¤ |
| `main.py` | å…¥å£ã€hashå‘½åã€TeeOutput | éœ€é€é¡¹ç¡®è®¤ |
| `run.sh` | å¯åŠ¨è„šæœ¬ | éœ€é€é¡¹ç¡®è®¤ |

---

## ä¸€ã€`model.py`

### 1.1 DST å®ç°ï¼ˆ`_dst_forward` / `_idst_backward`ï¼‰

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **å¥‡å»¶æ‹“é•¿åº¦**ï¼š`x_ext = cat([x, -flip(interior)])` å…¶ä¸­ `interior = x[1:-1]`ï¼Œå»¶æ‹“åé•¿åº¦ä¸º `N + (N-2) = 2N-2`ï¼Œå³ `2*(N-1)`ã€‚ç¡®è®¤ `irfft(n=2*(N-1))` ä¸å»¶æ‹“é•¿åº¦ä¸€è‡´ã€‚
- [ ] ğŸ”´ **è¾¹ç•Œç‚¹å¤„ç†**ï¼šDST å‡è®¾ `x[0]=x[N-1]=0`ï¼ˆDirichlet BCï¼‰ã€‚æ£€æŸ¥è®­ç»ƒæ•°æ®ä¸­ x æ–¹å‘è¾¹ç•Œæ˜¯å¦ç¡®å®æ¥è¿‘é›¶ï¼Œè‹¥ä¸æ˜¯åˆ™ DST ä¼šå¼•å…¥ Gibbs ç°è±¡ã€‚
- [ ] ğŸŸ¡ **é¢‘ç‡æˆªæ–­èŒƒå›´**ï¼š`modes_x=32` æ—¶ï¼Œ`x_ftx.shape[-2]` æ˜¯ `N-1+1 = N` è¿˜æ˜¯ `N-1`ï¼Ÿç¡®è®¤ `out_ft_x[:, :, :self.modes_x, :]` ä¸è¶Šç•Œã€‚
  ```python
  # éªŒè¯ï¼šrfft(n=2*(N-1)) çš„è¾“å‡ºé•¿åº¦ = (2*(N-1))//2 + 1 = N-1+1 = N
  # æ‰€ä»¥ n_freq_x = Nï¼Œmodes_x æœ€å¤§å¯å– N-1ï¼ˆä¸å« DCï¼‰
  # å½“å‰ modes_x=32 << 512ï¼Œå®‰å…¨
  ```
- [ ] ğŸŸ¢ **norm='ortho'**ï¼šå‰å‘å’Œåå‘éƒ½ç”¨ `ortho`ï¼Œèƒ½é‡å®ˆæ’ï¼Œæ­£ç¡®ã€‚

---

### 1.2 `SpectralConv2d_MHD.forward_fourier`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **fourier_weight é¡ºåº**ï¼š`self.fourier_weight[0]` å¯¹åº” `modes_y`ï¼Œ`self.fourier_weight[1]` å¯¹åº” `modes_x`ã€‚
  ```python
  for n_modes in [modes_y, modes_x]:   # [0]=y, [1]=x
  ```
  `weight_y = einsum(..., self.fourier_weight[0])` â€” yæ–¹å‘ç”¨ `[0]`ï¼Œxæ–¹å‘ç”¨ `[1]`ï¼Œ**ä¸åˆå§‹åŒ–é¡ºåºä¸€è‡´**ï¼Œâœ“
- [ ] ğŸ”´ **out_ft ç»´åº¦**ï¼šä¿®å¤å‰æ›¾æœ‰ `new_zeros(B, I, ...)` åº”ä¸º `new_zeros(B, O, ...)`ã€‚ç¡®è®¤å½“å‰ä»£ç ï¼š
  ```python
  O = self.out_dim
  out_ft_y = x_fty.new_zeros(B, O, M, N // 2 + 1)   # â† O è€Œé I
  out_ft_x = x_ftx.new_zeros(B, O, n_freq_x, N)      # â† O è€Œé I
  ```
- [ ] ğŸŸ¡ **Yæ–¹å‘ rfft ç»´åº¦**ï¼š`rfft(x, dim=-1)` å¯¹ Ny æ–¹å‘åš FFTï¼Œè¾“å‡º `(B, I, Nx, Ny//2+1)`ï¼Œç„¶å `irfft(n=N, dim=-1)` æ¢å¤ Nyï¼Œæ­£ç¡®ã€‚
- [ ] ğŸŸ¡ **Xæ–¹å‘ DST ç»´åº¦**ï¼š`_dst_forward(x, dim=-2)` å¯¹ Nx æ–¹å‘åš DSTï¼Œè¾“å‡º `(B, I, n_freq_x=Nx, Ny)`ï¼ˆæ³¨æ„ï¼šrfft çš„è¾“å‡ºé•¿åº¦æ˜¯ `(2*(Nx-1))//2+1 = Nx`ï¼‰ï¼Œç„¶å `_idst_backward(out_ft_x, M, dim=-2)` æ¢å¤ Nxï¼Œæ­£ç¡®ã€‚
- [ ] ğŸŸ¡ **einsum ä¸‹æ ‡**ï¼š
  - Yæ–¹å‘ï¼š`"bixy,bioy->boxy"` â€” `x`=Nxç»´ï¼Œ`y`=modes_yç»´ï¼Œè¾“å…¥ `(B,I,Nx,modes_y)`ï¼Œæƒé‡ `(B,I,O,modes_y)`ï¼Œè¾“å‡º `(B,O,Nx,modes_y)` âœ“
  - Xæ–¹å‘ï¼š`"bixy,biox->boxy"` â€” `x`=modes_xç»´ï¼Œ`y`=Nyç»´ï¼Œè¾“å…¥ `(B,I,modes_x,Ny)`ï¼Œæƒé‡ `(B,I,O,modes_x)`ï¼Œè¾“å‡º `(B,O,modes_x,Ny)` âœ“
- [ ] ğŸŸ¢ **æ®‹å·®åŠ æ³•**ï¼š`x = xx + xy`ï¼Œä¸¤ä¸ªæ–¹å‘çš„è¾“å‡ºç›´æ¥ç›¸åŠ ï¼Œshape å‡ä¸º `(B, O, Nx, Ny)`ï¼Œæ­£ç¡®ã€‚

---

### 1.3 `OutputHead`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **Conv1d è¾“å‡ºå°ºå¯¸éªŒè¯**ï¼ˆ`output_dim=10`ï¼‰ï¼š
  - è®­ç»ƒè·¯å¾„ï¼š`fc_a(80â†’36) â€– fc_b(80â†’34)` â†’ 70ç»´ â†’ `Conv1d(1,8,12,s=2)`: `(70-12)//2+1=30` â†’ `Conv1d(8,1,12,s=2)`: `(30-12)//2+1=10` âœ“
  - æ¨ç†è·¯å¾„ï¼š`fc_b(80â†’34)` â†’ 34ç»´ â†’ `Conv1d(1,8,12,s=2)`: `(34-12)//2+1=12` â†’ `Conv1d(8,1,12,s=2)`: `(12-12)//2+1=1` âœ“
  - **å¦‚æœä¿®æ”¹ `output_dim`ï¼Œä¸Šè¿°è®¡ç®—ä¼šå¤±æ•ˆ**ï¼Œéœ€é‡æ–°éªŒè¯æˆ–é‡æ–°è®¾è®¡ fc_a/fc_b çš„è¾“å‡ºç»´åº¦ã€‚
- [ ] ğŸŸ¡ **reshape æ­£ç¡®æ€§**ï¼š`h.reshape(-1, 1, h.shape[-1])` å°† `(B*Nx*Ny, dim)` å˜ä¸º `(B*Nx*Ny, 1, dim)`ï¼ŒConv1d åœ¨æœ€åä¸€ç»´æ“ä½œï¼Œç„¶å `h.reshape(B, Nx, Ny, -1)` æ¢å¤ï¼Œæ­£ç¡®ã€‚
- [ ] ğŸŸ¢ **5ä¸ªç‹¬ç«‹å¤´**ï¼šæ¯ä¸ªåœºæœ‰ç‹¬ç«‹çš„ `fc_a`, `fc_b`, `mlp`ï¼Œå‚æ•°ä¸å…±äº«ï¼Œæ­£ç¡®ã€‚

---

### 1.4 `OmniFluids2D.forward`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **`x = F.gelu(b)` è€Œé `x = F.gelu(x)`**ï¼šæœ€åç”¨çš„æ˜¯ `b`ï¼ˆæœ€åä¸€å±‚ SpectralConv çš„è¾“å‡ºï¼‰ï¼Œè€Œä¸æ˜¯ç´¯ç§¯çš„ `x`ã€‚è¿™æ˜¯åŸå§‹ nse2d çš„è®¾è®¡ï¼Œä½†**ä¸ç›´è§‰ç›¸å**ï¼ˆé€šå¸¸æœŸæœ›ç”¨æœ€ç»ˆçš„ `x`ï¼‰ã€‚ç¡®è®¤è¿™æ˜¯æœ‰æ„ä¸ºä¹‹è¿˜æ˜¯ bugã€‚
  ```python
  for i in range(self.n_layers):
      b = self.spectral_layers[i](x, att)
      x = x + b        # æ®‹å·®ç´¯ç§¯
  x = F.gelu(b)        # â† åªç”¨æœ€åä¸€å±‚çš„ bï¼Œä¸¢å¼ƒäº†ç´¯ç§¯çš„ xï¼
  ```
- [ ] ğŸ”´ **æ®‹å·®è¿æ¥çš„ dt_frac**ï¼š
  ```python
  dt_frac = arange(1, T+1) / T   # [1/T, 2/T, ..., 1]
  out = x_0.unsqueeze(-1) + out * dt_frac
  ```
  ç‰©ç†å«ä¹‰ï¼šç¬¬ t å¸§ = åˆå§‹çŠ¶æ€ + é¢„æµ‹å¢é‡ Ã— (t/T)ã€‚è¿™æ˜¯çº¿æ€§æ’å€¼å‡è®¾ï¼Œå¯¹äºéçº¿æ€§åŠ¨åŠ›å­¦ç³»ç»Ÿæ˜¯ä¸€ç§è¿‘ä¼¼ã€‚ç¡®è®¤è¿™ç¬¦åˆé¢„æœŸã€‚
- [ ] ğŸŸ¡ **params é»˜è®¤å€¼**ï¼šå½“ `params=None` æ—¶ä½¿ç”¨ `default_params`ï¼ˆ8ä¸ªå›ºå®šå€¼ï¼‰ã€‚è®­ç»ƒæ—¶ `params` å§‹ç»ˆä¸º `None`ï¼ˆ`train.py` ä¸­ `net(x_0)` æ²¡ä¼  paramsï¼‰ï¼Œæ„å‘³ç€**æ‰€æœ‰è®­ç»ƒæ ·æœ¬ä½¿ç”¨ç›¸åŒçš„ç‰©ç†å‚æ•°**ã€‚è¿™æ˜¯å¦åˆç†ï¼Ÿ
- [ ] ğŸŸ¡ **grid expand**ï¼š`self.grid.expand(B, -1, -1, -1)` ä¸åˆ†é…æ–°å†…å­˜ï¼Œæ­£ç¡®ã€‚

---

## äºŒã€`psm_loss.py`

### 2.1 `build_mhd_instance`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **device å­—ç¬¦ä¸²**ï¼š`cfg.device = str(device)`ï¼Œå½“ `device='cuda:0'` æ—¶ï¼Œ`FiveFieldMHD` å†…éƒ¨æ˜¯å¦æ­£ç¡®å¤„ç†è¿™ä¸ªå­—ç¬¦ä¸²ï¼Ÿç¡®è®¤ `FiveFieldMHD` æ¥å— `'cuda:0'` æ ¼å¼ã€‚
- [ ] ğŸŸ¡ **precision='fp64'**ï¼šRHS å§‹ç»ˆç”¨ fp64ï¼Œå³ä½¿æ¨¡å‹ç”¨ fp32ã€‚`make_mhd5_rhs_fn` ä¸­æœ‰ `x.to(torch.float64)` å’Œ `.to(model_dtype)` çš„è½¬æ¢ï¼Œæ­£ç¡®ã€‚
- [ ] ğŸŸ¢ **æ¯æ¬¡è®­ç»ƒåªå»ºä¸€ä¸ªå®ä¾‹**ï¼š`build_mhd_instance` åœ¨ `train()` å¼€å¤´è°ƒç”¨ä¸€æ¬¡ï¼Œä¸åœ¨æ¯æ­¥é‡å»ºï¼Œæ­£ç¡®ã€‚

---

### 2.2 `compute_physics_loss`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **`dt` çš„ç‰©ç†å«ä¹‰**ï¼š
  ```python
  dt = rollout_dt / output_dim   # = 0.1 / 10 = 0.01
  ```
  è¿™æ˜¯æ¯å¸§ä¹‹é—´çš„ç‰©ç†æ—¶é—´é—´éš”ï¼ˆ`train_dt`ï¼‰ã€‚`time_diff = (state_tp1 - state_t) / dt` æ˜¯æ•°å€¼æ—¶é—´å¯¼æ•°ï¼Œåº”ç­‰äº RHSã€‚ç¡®è®¤ `rollout_dt=0.1` æ—¶ `dt=0.01` ä¸ mhd_sim ä»¿çœŸ `dt_sim=2e-3` çš„å…³ç³»ï¼ˆ`train_dt` æ˜¯ `dt_sim` çš„ 5 å€ï¼‰ã€‚
- [ ] ğŸ”´ **`full_traj` çš„æ„å»º**ï¼š
  ```python
  full_traj = cat([x_0.unsqueeze(-1), pred_traj], dim=-1)
  # x_0: (B, Nx, Ny, 5) â†’ unsqueeze(-1) â†’ (B, Nx, Ny, 5, 1)
  # pred_traj: (B, Nx, Ny, 5, output_dim)
  # full_traj: (B, Nx, Ny, 5, output_dim+1)
  ```
  ç„¶å `full_traj[..., t]` å–ç¬¬ t å¸§ï¼Œshape `(B, Nx, Ny, 5)`ï¼Œæ­£ç¡®ã€‚
- [ ] ğŸ”´ **`target.detach()`**ï¼šRHS è®¡ç®—ç»“æœ detachï¼Œé˜²æ­¢æ¢¯åº¦æµè¿‡ RHSï¼ˆRHS æ˜¯å›ºå®šçš„ç‰©ç†æ–¹ç¨‹ï¼Œä¸åº”å‚ä¸åå‘ä¼ æ’­ï¼‰ã€‚âœ“
- [ ] ğŸŸ¡ **Crank-Nicolson çš„ `state_tp1`**ï¼š
  ```python
  target = (rhs_fn(state_t) + rhs_fn(state_tp1)) / 2.0
  ```
  `state_tp1` æ˜¯æ¨¡å‹çš„é¢„æµ‹è¾“å‡ºï¼ˆæœ‰æ¢¯åº¦ï¼‰ï¼Œä½† `rhs_fn(state_tp1)` è¢« `.detach()` äº†ã€‚è¿™æ„å‘³ç€ CN æ ¼å¼çš„éšå¼éƒ¨åˆ†ï¼ˆ`state_tp1` å¯¹ RHS çš„å½±å“ï¼‰è¢«æˆªæ–­äº†ï¼Œé€€åŒ–ä¸ºæ˜¾å¼ Euler + å¸¸æ•°åç§»ã€‚è¿™æ˜¯æœ‰æ„çš„ç®€åŒ–è¿˜æ˜¯éœ€è¦æ”¹è¿›ï¼Ÿ
- [ ] ğŸŸ¡ **æŸå¤±å½’ä¸€åŒ–**ï¼š`total_loss / output_dim` å¯¹å¸§æ•°å–å¹³å‡ï¼Œåˆç†ã€‚ä½†å„å¸§çš„ RHS é‡çº§å¯èƒ½å·®å¼‚è¾ƒå¤§ï¼ˆæ—©æœŸå¸§æ›´æ¥è¿‘åˆå§‹æ¡ä»¶ï¼‰ï¼Œæ˜¯å¦éœ€è¦åŠ æƒï¼Ÿ
- [ ] ğŸŸ¢ **MSE vs RMSE**ï¼šç”¨ `F.mse_loss`ï¼ˆä¸åŠ  `sqrt`ï¼‰ï¼Œä¸åŸå§‹ NSE2D çš„ `sqrt(MSE + EPS)` ä¸åŒã€‚è¿™æ˜¯æœ‰æ„æ”¹å˜è¿˜æ˜¯é—æ¼ï¼Ÿ

---

## ä¸‰ã€`tools.py`

### 3.1 `load_mhd5_snapshots`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **æ—¶é—´ç´¢å¼•è®¡ç®—**ï¼š
  ```python
  t_start_idx = int(round(time_start / dt_data))  # = round(250.0/1.0) = 250
  t_end_idx   = int(round(time_end / dt_data))    # = round(300.0/1.0) = 300
  states = states[:, t_start_idx:t_end_idx + 1]   # åŒ…å«ä¸¤ç«¯ï¼Œå…± 51 å¸§
  ```
  ç¡®è®¤æ•°æ®æ–‡ä»¶ä¸­ index=250 å¯¹åº” t=250sï¼ˆå³æ•°æ®ä» t=0 å¼€å§‹ï¼Œæ¯æ­¥ 1sï¼‰ã€‚å¦‚æœæ•°æ®ä» t=0 å¼€å§‹ä½†æ­¥é•¿ä¸æ˜¯ 1sï¼Œåˆ™ç´¢å¼•ä¼šé”™è¯¯ã€‚
- [ ] ğŸ”´ **æ•°æ®æ ¼å¼å‡è®¾**ï¼šä»£ç å‡è®¾æ•°æ®æ˜¯ `dict{'n': (B,T,Nx,Ny), 'U': ..., ...}`ã€‚å¦‚æœå®é™…æ•°æ®æ ¼å¼ä¸åŒï¼ˆå¦‚ `(B,T,C,Nx,Ny)` çš„å•å¼ é‡ï¼‰ï¼Œä¼šæŠ¥é”™ã€‚
- [ ] ğŸŸ¡ **Flatten é€»è¾‘**ï¼š
  ```python
  snapshots = states.reshape(B*T, C, Nx, Ny).permute(0, 2, 3, 1).float()
  # â†’ (B*T, Nx, Ny, 5)  channel-last
  ```
  è®­ç»ƒæ—¶æ¯ä¸ªæ ·æœ¬æ˜¯å•å¸§å¿«ç…§ï¼Œç‰©ç†æŸå¤±ç”¨æ¨¡å‹é¢„æµ‹çš„å¤šå¸§è½¨è¿¹ã€‚è¿™æ„å‘³ç€**è®­ç»ƒæ—¶æ²¡æœ‰æ—¶é—´è¿ç»­æ€§çº¦æŸ**ï¼ˆéšæœºæ‰“ä¹±äº†æ—¶é—´é¡ºåºï¼‰ï¼Œåªæœ‰ç‰©ç†æ–¹ç¨‹çº¦æŸã€‚è¿™æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ
- [ ] ğŸŸ¢ **float32 è½¬æ¢**ï¼š`.float()` å°† fp64 æ•°æ®è½¬ä¸º fp32ï¼Œæ­£ç¡®ï¼ˆæ¨¡å‹ç”¨ fp32ï¼‰ã€‚

---

### 3.2 `load_mhd5_trajectories`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸŸ¡ **ä¸ `load_mhd5_snapshots` çš„åŒºåˆ«**ï¼š
  - `snapshots`ï¼š`(B*T, Nx, Ny, 5)` channel-lastï¼Œç”¨äºè®­ç»ƒ
  - `trajectories`ï¼š`(B, T, 5, Nx, Ny)` channel-firstï¼Œç”¨äºè¯„ä¼°
  - ä¸¤ä¸ªå‡½æ•°çš„æ—¶é—´åˆ‡ç‰‡é€»è¾‘ç›¸åŒï¼Œä½†è¾“å‡ºæ ¼å¼ä¸åŒã€‚ç¡®è®¤è¯„ä¼°æ—¶æ­£ç¡®ä½¿ç”¨ `trajectories`ã€‚
- [ ] ğŸŸ¢ **ä¸ Flatten**ï¼šä¿ç•™ `(B, T, ...)` ç»“æ„ç”¨äº autoregressive rolloutï¼Œæ­£ç¡®ã€‚

---

## å››ã€`train.py`

### 4.1 `save_eval_plots`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **å›¾åƒè½¬ç½®**ï¼š`imshow(gt_snap.T, origin='lower')` â€” æ•°æ® `(Nx=512, Ny=256)`ï¼Œè½¬ç½®å `(256, 512)`ï¼Œimshow çš„è¡Œ=yè½´=Ny=256ï¼Œåˆ—=xè½´=Nx=512ï¼Œå³ x è½´ï¼ˆradialï¼‰æ°´å¹³ï¼Œy è½´ï¼ˆbinormalï¼‰å‚ç›´ã€‚ç¡®è®¤è¿™ä¸ç‰©ç†åæ ‡çº¦å®šä¸€è‡´ã€‚
- [ ] ğŸ”´ **ç‰©ç†æ—¶é—´æ ‡ç­¾**ï¼š
  ```python
  t_phys = time_start + t * n_substeps * rollout_dt
  # t=0: 250 + 0*10*0.1 = 250.0s  (IC)
  # t=1: 250 + 1*10*0.1 = 251.0s
  # t=10: 250 + 10*10*0.1 = 260.0s
  ```
  ç¡®è®¤ `t` æ˜¯ data stepï¼ˆæ¯æ­¥å¯¹åº” `dt_data=1s`ï¼‰ï¼Œ`n_substeps=10`ï¼Œ`rollout_dt=0.1`ï¼Œä¹˜ç§¯ = 1s/data_stepï¼Œæ­£ç¡®ã€‚
- [ ] ğŸŸ¡ **åŒ x è½´å¯¹é½**ï¼š`twiny()` åè®¾ç½® xlim åŸºäº `nfe_lo/hi * rollout_dt`ã€‚æ³¨æ„ `axes[0].get_xlim()` åœ¨ `plot()` åè°ƒç”¨ï¼Œxlim å¯èƒ½è¿˜æœªç¨³å®šï¼ˆmatplotlib è‡ªåŠ¨è°ƒæ•´ï¼‰ã€‚å»ºè®®åœ¨ `tight_layout()` ä¹‹å‰è®¾ç½®ï¼Œæˆ–æ‰‹åŠ¨å›ºå®š xlimã€‚
- [ ] ğŸŸ¡ **`plot_steps` è¾¹ç•Œ**ï¼š`plot_steps = [0, n//4, n//2, 3n//4, n]`ï¼Œè¿‡æ»¤ `< pred_traj.shape[1]`ã€‚å½“ `n_steps=10` æ—¶ï¼Œ`n=10` è¢«è¿‡æ»¤ï¼ˆ`< 11`ï¼‰ï¼Œå®é™…ä¼šåŒ…å« t=10ã€‚ç¡®è®¤ `pred_traj.shape[1] = n_steps+1`ï¼ˆå«åˆå§‹å¸§ï¼‰ï¼Œæ‰€ä»¥ `t=n_steps` åˆæ³•ã€‚âœ“

---

### 4.2 `evaluate`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **channel æ ¼å¼è½¬æ¢**ï¼š
  ```python
  x_0 = trajectories[:, 0].permute(0, 2, 3, 1).to(device)
  # trajectories[:, 0]: (B, 5, Nx, Ny)
  # permute(0,2,3,1): (B, Nx, Ny, 5)  â† channel-lastï¼Œæ¨¡å‹è¾“å…¥æ ¼å¼ âœ“
  ```
  ```python
  pred_cf = current.permute(0, 3, 1, 2).unsqueeze(1)
  # current: (B, Nx, Ny, 5)
  # permute(0,3,1,2): (B, 5, Nx, Ny)  â† channel-first
  # unsqueeze(1): (B, 1, 5, Nx, Ny)   â† æ’å…¥æ—¶é—´ç»´åº¦ âœ“
  ```
- [ ] ğŸ”´ **`out[..., -1]`**ï¼šæ¨ç†æ—¶ `net(current, inference=True)` è¾“å‡º `(B, Nx, Ny, 5, 1)`ï¼Œ`out[..., -1]` å–æœ€åå¸§å¾— `(B, Nx, Ny, 5)`ï¼Œæ­£ç¡®ã€‚
- [ ] ğŸŸ¡ **`pred_list[0]`**ï¼šåˆå§‹å¸§ `trajectories[:, 0:1]` æ˜¯ `(B, 1, 5, Nx, Ny)` channel-firstï¼Œåç»­ `pred_cf` ä¹Ÿæ˜¯ channel-firstï¼Œ`cat(pred_list, dim=1)` å¾— `(B, T, 5, Nx, Ny)`ï¼Œä¸ `gt` æ ¼å¼ä¸€è‡´ã€‚âœ“
- [ ] ğŸŸ¡ **è¯„ä¼°ç”¨è®­ç»ƒæ•°æ®**ï¼š`eval_data_path = config.data_path`ï¼Œå³ç”¨åŒä¸€ä»½æ•°æ®è¯„ä¼°ã€‚æ²¡æœ‰ç‹¬ç«‹çš„éªŒè¯é›†/æµ‹è¯•é›†ã€‚è¿™æ„å‘³ç€è¯„ä¼°ç»“æœåæ˜ çš„æ˜¯è®­ç»ƒé›†ä¸Šçš„æ€§èƒ½ï¼Œå¯èƒ½è¿‡äºä¹è§‚ã€‚
- [ ] ğŸŸ¢ **`net.train()` æ¢å¤**ï¼šè¯„ä¼°ç»“æŸåè°ƒç”¨ `net.train()`ï¼Œæ­£ç¡®ã€‚

---

### 4.3 `train`ï¼ˆè®­ç»ƒå¾ªç¯ï¼‰

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **`net(x_0)` æ²¡æœ‰ä¼  params**ï¼š
  ```python
  pred_traj = net(x_0)   # params=None â†’ ä½¿ç”¨ default_params
  ```
  æ‰€æœ‰è®­ç»ƒæ ·æœ¬ä½¿ç”¨ç›¸åŒçš„é»˜è®¤ç‰©ç†å‚æ•°ã€‚å¦‚æœæ•°æ®æ¥è‡ªä¸åŒç‰©ç†å‚æ•°çš„ä»¿çœŸï¼Œè¿™ä¼šå¯¼è‡´ MoE æ— æ³•åŒºåˆ†ä¸åŒå‚æ•°çš„åŠ¨åŠ›å­¦ã€‚**è¿™æ˜¯å½“å‰å®ç°çš„é‡è¦é™åˆ¶**ã€‚
- [ ] ğŸ”´ **`compute_physics_loss` çš„è¾“å…¥**ï¼š
  ```python
  loss = compute_physics_loss(pred_traj, x_0, rhs_fn, ...)
  # pred_traj: (B, Nx, Ny, 5, output_dim)  â† net çš„è¾“å‡º
  # x_0: (B, Nx, Ny, 5)  â† åŠ äº†å™ªå£°åçš„è¾“å…¥
  ```
  æ³¨æ„ï¼š`x_0` æ˜¯åŠ äº†å™ªå£°çš„ç‰ˆæœ¬ï¼Œè€Œ `pred_traj` æ˜¯ä»åŠ å™ªå£°çš„ `x_0` å‡ºå‘çš„é¢„æµ‹ã€‚`full_traj` ä¸­ç¬¬ 0 å¸§æ˜¯åŠ å™ªå£°çš„ `x_0`ï¼ŒRHS è®¡ç®—ä¹ŸåŸºäºåŠ å™ªå£°çš„çŠ¶æ€ã€‚è¿™å¯èƒ½å¯¼è‡´ç‰©ç†æŸå¤±è®¡ç®—çš„å‚è€ƒçŠ¶æ€ä¸å‡†ç¡®ã€‚
- [ ] ğŸŸ¡ **`OneCycleLR` çš„ `total_steps`**ï¼š
  ```python
  scheduler = OneCycleLR(optimizer, max_lr=config.lr,
                         total_steps=config.num_iterations + 1)
  ```
  ä½†å®é™…å¾ªç¯æ˜¯æŒ‰ epoch çš„ï¼Œ`global_step` å¯èƒ½è¶…è¿‡ `num_iterations`ï¼ˆæœ€åä¸€ä¸ª epoch çš„å‰©ä½™æ­¥ï¼‰ã€‚`scheduler.step()` è¶…è¿‡ `total_steps` ä¼šæŠ¥é”™ã€‚ç¡®è®¤ `drop_last=True` å’Œ epoch ç»“æ„æ˜¯å¦ä¼šå¯¼è‡´ `global_step > num_iterations + 1`ã€‚
- [ ] ğŸŸ¡ **`epoch_loss` è·¨ epoch ç´¯ç§¯**ï¼š`epoch_loss` å’Œ `n_batches` åœ¨æ¯ä¸ª epoch å¼€å§‹æ—¶é‡ç½®ï¼Œä½† `avg_loss` çš„è®¡ç®—ç”¨çš„æ˜¯å½“å‰ epoch å†…çš„å¹³å‡ï¼Œè€Œéå…¨å±€å¹³å‡ã€‚æ—¥å¿—ä¸­çš„ `avg` åœ¨ epoch è¾¹ç•Œå¤„ä¼šè·³å˜ã€‚
- [ ] ğŸŸ¡ **æ¨¡å‹é€‰æ‹©åŸºäº eval ç›¸å¯¹ L2**ï¼š`best_loss` ç”¨ `mean_rel_l2` æ›´æ–°ï¼Œä½†è¯„ä¼°ç”¨çš„æ˜¯è®­ç»ƒæ•°æ®ï¼ˆè§ä¸Šï¼‰ã€‚
- [ ] ğŸŸ¢ **`drop_last=True`**ï¼šDataLoader ä¸¢å¼ƒæœ€åä¸è¶³ batch_size çš„æ ·æœ¬ï¼Œé˜²æ­¢ batch å¤§å°ä¸ä¸€è‡´ï¼Œæ­£ç¡®ã€‚
- [ ] ğŸŸ¢ **`set_to_none=True`**ï¼š`optimizer.zero_grad(set_to_none=True)` æ¯” `zero_grad()` æ›´çœå†…å­˜ï¼Œæ­£ç¡®ã€‚

---

## äº”ã€`main.py`

### 5.1 `TeeOutput`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸŸ¡ **`sys.stderr` æœªé‡å®šå‘**ï¼š`TeeOutput` åªé‡å®šå‘ `stdout`ï¼Œ`stderr`ï¼ˆå¦‚ Python å¼‚å¸¸ã€è­¦å‘Šï¼‰ä¸ä¼šå†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚å¦‚æœè®­ç»ƒå´©æºƒï¼Œæ—¥å¿—æ–‡ä»¶å¯èƒ½ç¼ºå°‘é”™è¯¯ä¿¡æ¯ã€‚
- [ ] ğŸŸ¡ **æ–‡ä»¶æœªå…³é—­**ï¼š`TeeOutput` æ²¡æœ‰ `close()` æ–¹æ³•ï¼Œè®­ç»ƒç»“æŸåæ–‡ä»¶å¥æŸ„ä¸ä¼šæ˜¾å¼å…³é—­ï¼ˆä¾èµ– GCï¼‰ã€‚æ­£å¸¸æƒ…å†µä¸‹é—®é¢˜ä¸å¤§ï¼Œä½†å¼‚å¸¸é€€å‡ºæ—¶å¯èƒ½ä¸¢å¤±æœ€åå‡ è¡Œæ—¥å¿—ã€‚
- [ ] ğŸŸ¢ **åŒå†™æ­£ç¡®**ï¼š`write` åŒæ—¶å†™ terminal å’Œ fileï¼Œ`flush` åŒæ—¶ flushï¼Œæ­£ç¡®ã€‚

---

### 5.2 `generate_run_hash`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸŸ¡ **å«æ—¶é—´æˆ³**ï¼šhash åŒ…å« `datetime.now().isoformat()`ï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¸åŒï¼Œæ— æ³•å¤ç°ç›¸åŒ hashã€‚è¿™æ˜¯æœ‰æ„çš„ï¼ˆä¿è¯å”¯ä¸€æ€§ï¼‰ï¼Œä½†æ„å‘³ç€ç›¸åŒè¶…å‚æ•°çš„ä¸¤æ¬¡è¿è¡Œä¼šæœ‰ä¸åŒ hashï¼Œæ— æ³•é€šè¿‡ hash è¯†åˆ«é‡å¤å®éªŒã€‚
- [ ] ğŸŸ¢ **8ä½æˆªæ–­**ï¼šMD5 çš„å‰ 8 ä½ï¼Œç¢°æ’æ¦‚ç‡çº¦ 1/2^32ï¼Œè¶³å¤Ÿå®éªŒå‘½åä½¿ç”¨ã€‚

---

### 5.3 `run_train`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **`T=cfg.temperature`**ï¼šæ¨¡å‹å‚æ•°åæ˜¯ `T`ï¼ˆMoE softmax æ¸©åº¦ï¼‰ï¼Œä½† argparse å‚æ•°åæ˜¯ `--temperature`ã€‚ç¡®è®¤ä¸ä¸ç‰©ç†æ—¶é—´ `T` æ··æ·†ã€‚
- [ ] ğŸŸ¡ **`factor` å’Œ `n_ff_layers` æ²¡æœ‰åœ¨ run.sh ä¸­æš´éœ²**ï¼šä½¿ç”¨é»˜è®¤å€¼ `factor=4, n_ff_layers=2`ã€‚å¦‚éœ€è°ƒæ•´éœ€ç›´æ¥ä¿®æ”¹ `main.py` é»˜è®¤å€¼æˆ– `run.sh`ã€‚
- [ ] ğŸŸ¢ **`n_fields=5` ç¡¬ç¼–ç **ï¼šåœ¨ `run_train` ä¸­å›ºå®šä¸º 5ï¼Œä¸é€šè¿‡ argparse ä¼ å…¥ï¼Œåˆç†ï¼ˆMHD5F å›ºå®šä¸º 5 åœºï¼‰ã€‚

---

### 5.4 `run_inference`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **`factor` å’Œ `n_ff_layers` æœªä» checkpoint æ¢å¤**ï¼š
  ```python
  net = OmniFluids2D(
      ...
      # factor å’Œ n_ff_layers æœªä¼ å…¥ï¼Œä½¿ç”¨é»˜è®¤å€¼ factor=4, n_ff_layers=2
  )
  ```
  å¦‚æœè®­ç»ƒæ—¶ç”¨äº†éé»˜è®¤å€¼ï¼Œæ¨ç†æ—¶æ¨¡å‹ç»“æ„ä¼šä¸åŒ¹é…ï¼Œ`load_state_dict` ä¼šå¤±è´¥æˆ–é™é»˜é”™è¯¯ã€‚
- [ ] ğŸŸ¡ **`rollout_dt` æœªä» checkpoint æ¢å¤**ï¼šæ¨ç†æ—¶çš„ `rollout_dt` æ¥è‡ªå‘½ä»¤è¡Œå‚æ•°ï¼Œè€Œé checkpointã€‚å¦‚æœè®­ç»ƒå’Œæ¨ç†çš„ `rollout_dt` ä¸åŒï¼ŒNFE è®¡ç®—ä¼šé”™è¯¯ã€‚
- [ ] ğŸŸ¡ **`time_start` æœªä» checkpoint æ¢å¤**ï¼šæ¨ç†æ—¶çš„ `time_start` æ¥è‡ªå‘½ä»¤è¡Œï¼ˆé»˜è®¤ 250.0ï¼‰ï¼Œå¦‚æœæ¨ç†æ•°æ®æ—¶é—´çª—å£ä¸åŒï¼Œå¯è§†åŒ–çš„ç‰©ç†æ—¶é—´æ ‡ç­¾ä¼šé”™è¯¯ã€‚
- [ ] ğŸŸ¢ **`weights_only=False`**ï¼šåŠ è½½ checkpoint æ—¶å…è®¸åŠ è½½ä»»æ„å¯¹è±¡ï¼ˆåŒ…æ‹¬ `config` dictï¼‰ï¼Œæ­£ç¡®ã€‚

---

## å…­ã€`run.sh`

**æ£€æŸ¥ç‚¹ï¼š**

- [ ] ğŸ”´ **`modes_x=32, modes_y=32`**ï¼šå½“å‰ run.sh ä¸­è®¾ç½®çš„æ˜¯ 32ï¼Œè€Œ `main.py` é»˜è®¤æ˜¯ 128ã€‚ç¡®è®¤è¿™æ˜¯æœ‰æ„çš„ï¼ˆå°æ¨¡å‹å®éªŒï¼‰ï¼Œè¿˜æ˜¯é—å¿˜æ›´æ–°ã€‚
- [ ] ğŸ”´ **`batch_size=8`**ï¼šå½“å‰ run.sh è®¾ç½® 8ï¼Œè€Œ `main.py` é»˜è®¤æ˜¯ 4ã€‚ç¡®è®¤æ˜¾å­˜æ˜¯å¦è¶³å¤Ÿï¼ˆmodes=32 æ—¶å‚æ•°é‡çº¦ 40Mï¼Œbatch=8 åº”å¯è¡Œï¼‰ã€‚
- [ ] ğŸŸ¡ **`eval_rollout_steps=10`**ï¼šè®­ç»ƒæ—¶è¯„ä¼°åªåš 10 æ­¥ï¼ˆ10sï¼‰ï¼Œè¦†ç›–æ•°æ®çª—å£çš„ 20%ï¼ˆ50s æ€»çª—å£ï¼‰ã€‚æ¨ç†æ—¶ç”¨ 50 æ­¥ã€‚ç¡®è®¤ 10 æ­¥è¯„ä¼°è¶³å¤Ÿåæ˜ æ¨¡å‹æ€§èƒ½ã€‚
- [ ] ğŸŸ¡ **`num_iterations=200000`**ï¼š20 ä¸‡æ­¥ï¼Œä»¥ 0.5 it/s è®¡çº¦ 111 å°æ—¶ï¼ˆ4.6 å¤©ï¼‰ã€‚ç¡®è®¤è¿™æ˜¯é¢„æœŸçš„è®­ç»ƒæ—¶é•¿ã€‚
- [ ] ğŸŸ¢ **conda æ¿€æ´»**ï¼š`ARGS=("$@"); set --; source activate; conda activate` æ­£ç¡®å¤„ç†äº† conda æ¿€æ´»ä¸ä½ç½®å‚æ•°çš„å†²çªã€‚

---

## ä¸ƒã€è·¨æ–‡ä»¶ä¸€è‡´æ€§æ£€æŸ¥

- [ ] ğŸ”´ **`FIELD_NAMES` å®šä¹‰é‡å¤**ï¼šåœ¨ `tools.py` å’Œ `train.py` ä¸­å„å®šä¹‰äº†ä¸€æ¬¡ `FIELD_NAMES = ['n', 'U', 'vpar', 'psi', 'Ti']`ã€‚å¦‚æœé¡ºåºä¸ä¸€è‡´ä¼šå¯¼è‡´åœºæ ‡ç­¾é”™è¯¯ã€‚ç¡®è®¤ä¸¤å¤„å®Œå…¨ç›¸åŒã€‚
- [ ] ğŸ”´ **æ•°æ®æ ¼å¼æµè½¬**ï¼š
  ```
  æ•°æ®æ–‡ä»¶: dict{field: (B, T, Nx, Ny)}
      â†“ load_mhd5_snapshots
  è®­ç»ƒè¾“å…¥: (B*T, Nx, Ny, 5)  channel-last
      â†“ net(x_0)
  æ¨¡å‹è¾“å‡º: (B, Nx, Ny, 5, 10)  channel-last + time
      â†“ compute_physics_loss
  æŸå¤±: scalar

  æ•°æ®æ–‡ä»¶: dict{field: (B, T, Nx, Ny)}
      â†“ load_mhd5_trajectories
  è¯„ä¼°è½¨è¿¹: (B, T, 5, Nx, Ny)  channel-first
      â†“ permute(0,2,3,1)
  æ¨¡å‹è¾“å…¥: (B, Nx, Ny, 5)  channel-last
      â†“ net(x, inference=True)
  æ¨¡å‹è¾“å‡º: (B, Nx, Ny, 5, 1)
      â†“ out[..., -1] â†’ permute(0,3,1,2)
  é¢„æµ‹å¸§: (B, 5, Nx, Ny)  channel-first
  ```
  é€æ­¥ç¡®è®¤æ¯ä¸ª permute/reshape æ“ä½œçš„ shape æ­£ç¡®ã€‚
- [ ] ğŸ”´ **`dt_data` å‡è®¾**ï¼šä»£ç å‡è®¾ `dt_data=1.0`ï¼ˆæ•°æ®æ¯æ­¥ 1sï¼‰ã€‚å¦‚æœå®é™…æ•°æ®æ­¥é•¿ä¸æ˜¯ 1sï¼Œæ—¶é—´ç´¢å¼•å’Œç‰©ç†æ—¶é—´æ ‡ç­¾éƒ½ä¼šé”™è¯¯ã€‚ç¡®è®¤æ•°æ®æ–‡ä»¶çš„å®é™…æ—¶é—´åˆ†è¾¨ç‡ã€‚
- [ ] ğŸŸ¡ **`n_substeps` è®¡ç®—**ï¼š`n_substeps = round(dt_data / rollout_dt) = round(1.0/0.1) = 10`ã€‚å¦‚æœ `rollout_dt` ä¸èƒ½æ•´é™¤ `dt_data`ï¼Œ`round` ä¼šå¼•å…¥è¯¯å·®ã€‚ä¾‹å¦‚ `rollout_dt=0.3` æ—¶ `n_substeps=3`ï¼Œä½† `3*0.3=0.9 â‰  1.0`ã€‚
- [ ] ğŸŸ¢ **`mhd` å®ä¾‹åœ¨ train å’Œ evaluate ä¸­å…±äº«**ï¼š`mhd` åœ¨ `train()` å¼€å¤´å»ºç«‹ï¼Œä¼ ç»™ `evaluate()`ï¼Œä¸é‡å»ºï¼Œæ­£ç¡®ã€‚

---

## å…«ã€å·²çŸ¥æ½œåœ¨é—®é¢˜æ±‡æ€»ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

| ä¼˜å…ˆçº§ | é—®é¢˜ | ä½ç½® | å½±å“ |
|--------|------|------|------|
| ğŸ”´ P1 | è®­ç»ƒæ—¶ `params=None`ï¼Œæ‰€æœ‰æ ·æœ¬ç”¨é»˜è®¤ç‰©ç†å‚æ•°ï¼ŒMoE æ— æ³•å‘æŒ¥ä½œç”¨ | `train.py:260` | æ¨¡å‹æ— æ³•åŒºåˆ†ä¸åŒç‰©ç†å‚æ•° |
| ğŸ”´ P2 | `x = F.gelu(b)` ç”¨æœ€åä¸€å±‚ b è€Œéç´¯ç§¯ x | `model.py:256` | å¯èƒ½æ˜¯ bugï¼Œä¸¢å¼ƒäº†æ®‹å·®ç´¯ç§¯ |
| ğŸ”´ P3 | `run_inference` æœªæ¢å¤ `factor`, `n_ff_layers` | `main.py:108-119` | æ¨ç†æ—¶æ¨¡å‹ç»“æ„å¯èƒ½ä¸åŒ¹é… |
| ğŸ”´ P4 | è¯„ä¼°ç”¨è®­ç»ƒæ•°æ®ï¼Œæ— ç‹¬ç«‹éªŒè¯é›† | `train.py:293` | æ— æ³•åˆ¤æ–­æ˜¯å¦è¿‡æ‹Ÿåˆ |
| ğŸ”´ P5 | åŠ å™ªå£°çš„ `x_0` ä½œä¸º `full_traj` çš„ç¬¬ 0 å¸§ | `train.py:262-263` | ç‰©ç†æŸå¤±å‚è€ƒçŠ¶æ€ä¸å‡†ç¡® |
| ğŸŸ¡ P6 | CN æ ¼å¼ä¸­ `rhs_fn(state_tp1).detach()` é€€åŒ–ä¸ºæ˜¾å¼ | `psm_loss.py:82` | CN ç²¾åº¦æŸå¤±ï¼Œé€€åŒ–ä¸º Euler |
| ğŸŸ¡ P7 | `OneCycleLR total_steps` å¯èƒ½è¢«è¶…è¿‡ | `train.py:227-229` | å¯èƒ½æŠ¥é”™ |
| ğŸŸ¡ P8 | `twiny()` çš„ xlim åœ¨ tight_layout å‰è®¾ç½®å¯èƒ½ä¸ç¨³å®š | `train.py:55-57` | ä¸Šæ–¹æ—¶é—´è½´å¯èƒ½ä¸å‡†ç¡® |
| ğŸŸ¡ P9 | `modes_x=32` åœ¨ run.sh ä½† `main.py` é»˜è®¤ 128 | `run.sh:42` | é…ç½®ä¸ä¸€è‡´ï¼Œå®¹æ˜“æ··æ·† |
| ğŸŸ¢ P10 | `TeeOutput` æ—  `close()`ï¼Œå¼‚å¸¸é€€å‡ºå¯èƒ½ä¸¢æ—¥å¿— | `main.py:15-27` | å°æ¦‚ç‡ä¸¢å¤±æ—¥å¿— |

---

*æ£€æŸ¥æ¸…å•ç”Ÿæˆæ—¶é—´ï¼š2026-02-24*
*è¦†ç›–æ–‡ä»¶ï¼šmodel.py, psm_loss.py, tools.py, train.py, main.py, run.sh*
