# KSE → HW 方程迁移深度分析

> 本文档对比 2D Kuramoto-Sivashinsky (KSE) 与 2D Hasegawa-Wakatani (HW) 方程的数学结构、物理特性、
> 代码实现差异，并逐模块分析 OmniFluids pipeline 迁移所需的改动。
> **本文档仅做分析，不确定最终实现方案。**

---

## 1. 方程对比：数学结构

### 1.1 KSE 方程（单场标量 PDE）

```
∂u/∂t + param1·(Δu + Δ²u) + 0.5·param2·|∇u|² = 0
```

- **未知量**: 1 个标量场 `u(x,y,t)`
- **线性项**: `Δu + Δ²u`（二阶扩散 + 四阶超扩散）
- **非线性项**: `|∇u|² = (∂u/∂x)² + (∂u/∂y)²`（梯度平方）
- **可变参数**: param1（线性项系数）, param2（非线性项系数），2 个标量
- **Forcing**: 无

### 1.2 HW 方程（双场耦合 PDE 系统）

```
∂ζ/∂t = -[φ, ζ] + α·(φ - n) + D(ζ)
∂n/∂t = -[φ, n] - κ·∂φ/∂y + α·(φ - n) + D(n)

约束: ∇²φ = ζ  (Poisson 方程, φ 由 ζ 唯一确定)
耗散: D(f) = -ν·(-∇²)^N·f  (超扩散, 通常 N=3 即 6 阶)
```

- **未知量**: 2 个耦合场 `ζ(x,y,t)` (涡度) 和 `n(x,y,t)` (密度扰动)
- **导出量**: `φ(x,y,t)` (电势/流函数，由 Poisson 方程从 ζ 求解)
- **非线性项**: Poisson 括号 `[φ, f] = ∂φ/∂x·∂f/∂y - ∂φ/∂y·∂f/∂x`（对流）
- **线性耦合**: `α·(φ - n)`（绝热耦合，同时出现在两个方程中）
- **线性驱动**: `-κ·∂φ/∂y`（密度梯度驱动，仅在 n 方程中）
- **超扩散**: `-ν·k^{2N}`（频域）
- **物理参数**: α (耦合强度), κ (密度梯度), ν (超黏性系数), N (超扩散阶数)

### 1.3 结构对比表

| 维度 | KSE | HW |
|------|-----|-----|
| 未知场数 | **1** (u) | **2** (ζ, n) + 导出场 φ |
| 参数空间 | 2 标量 (param1, param2) | 至少 3 连续标量 (α, κ, ν) + 1 离散 (N) |
| 非线性类型 | 梯度平方 `\|∇u\|²` | Poisson 括号 `[φ, f]` |
| 非线性来源 | 自身场 u | 导出场 φ 与各场的交叉项 |
| 需要辅助求解? | 否 | 是 (Poisson: ∇²φ = ζ) |
| 耗散机制 | 4 阶 (Δ²u), 系数=param1 | 2N 阶 (通常 6 阶), 系数=ν |
| 方程间耦合 | 无 (单方程) | 强耦合 (α 项同时出现在两个方程) |
| 对称性 | 各向同性 | **各向异性** (κ 项只在 y 方向) |
| Forcing | 无 | 无显式外力, 但 κ 梯度驱动是能量来源 |

---

## 2. 物理域与波数对比

### 2.1 域大小

| | KSE | HW |
|---|---|---|
| 物理域 | `[0, 8π]²` ≈ `[0, 25.13]²` | `[0, 2π/k0]²`，k0=0.15 时 ≈ `[0, 41.89]²` |
| 域大小由什么决定 | 波数缩放因子 1/4（硬编码） | 基频 k0（可配置参数） |
| 周期边界 | 是 | 是 |

### 2.2 波数构造

**KSE** (`kse.py` 第 28 行):
```python
kx = 1/4 * torch.fft.fftfreq(N, d=1.0/N)  # = n/4, 对应 L=8π
```

**HW** (`spectral_2d.py` 第 41 行):
```python
kx = torch.fft.fftfreq(Nx, d=dx/(2*pi))   # = 2πn/L = n·k0, 对应 L=2π/k0
```

**关键区别**: KSE 用 `fftfreq(N, d=1/N)` 得到整数后乘 1/4；HW 用 `fftfreq(N, d=dx/(2π))` 直接得到角频率。数学上等价，但代码约定不同——PSM loss 必须与 solver 使用**完全相同**的波数约定。

### 2.3 深层含义: k0 是否应该作为可变参数?

如果 k0 变化，域大小 L 也变化，这意味着:
- 同样 N 个格点覆盖不同的物理尺度
- 波数网格完全不同
- 模型的 `get_grid` 位置编码含义变化

**这是一个需要深思的设计决策**:
- 若固定 k0: 波数构造可以硬编码在 PSM loss 中，模型 grid 编码不变
- 若 k0 可变: PSM loss 中波数需要动态构造，grid 编码需要调整或保持归一化

---

## 3. 物理参数空间深度分析

### 3.1 各参数的物理意义与变化范围

| 参数 | 符号 | 物理意义 | 典型范围 | 对动力学的影响 |
|------|------|---------|---------|--------------|
| 耦合强度 | α | 控制涡度-密度耦合 | 0.01 ~ 10 | α→0: 流体力学极限(解耦)；α→∞: 绝热极限(n≈φ)；α≈1: 过渡态(最复杂) |
| 密度梯度 | κ | 背景密度梯度驱动 | 0.1 ~ 5 | κ 越大, 漂移波不稳定性越强, 湍流强度越大 |
| 超黏性 | ν | 小尺度耗散 | 1e-6 ~ 1e-3 | ν 越大, 小尺度衰减越快, 有效分辨率降低 |
| 超扩散阶数 | N | 耗散的空间阶数 | 通常固定=3 | N 越大, 耗散越集中在最高波数 |
| 基频 | k0 | 域大小 L=2π/k0 | 0.05 ~ 0.5 | k0 越小, 域越大, 不稳定模态越多 |

### 3.2 哪些参数应该进入 MoO（专家路由 MLP f_nu）?

**用户要求: 所有 HW 超参数都作为 MoO 输入。** 这意味着 f_nu 的输入不再是 2 维或 1 维，而是至少 3 维甚至更高。逐一分析:

**α (耦合强度)** — **必须入 MoO**
- 直接改变方程结构: α=0 时两方程解耦, α→∞ 时退化为单方程
- 不同 α 对应完全不同的动力学 regime, 需要不同的 Fourier 核策略
- 类比 KSE 的 param1

**κ (密度梯度)** — **必须入 MoO**
- 控制不稳定性驱动强度, 不同 κ 的湍流统计特性差异大
- 仅影响 n 方程, 但通过耦合间接影响 ζ
- 类比 KSE 的 param2

**ν (超黏性)** — **应该入 MoO**
- 控制耗散强度, 直接影响有效分辨率和能谱形状
- ν 跨数量级变化 (1e-6 ~ 1e-3), 对小尺度结构影响巨大
- 类比 NSE 中 nu 的角色 (NSE 中 nu 是唯一的路由输入)
- **尺度处理**: ν 跨多个量级，建议用 log 尺度输入 (如 NSE 中 visc = -log10(Re))

**N (超扩散阶数)** — **需要讨论**
- 离散整数 (通常 2 或 3)，不太适合连续 MLP 输入
- 如果固定 N=3，则不需要作为输入
- 如果要支持 N∈{2,3,4}，可以做 one-hot 或 embedding
- **建议**: 初版固定 N=3，后续如需可变再扩展

**k0 (基频/域大小)** — **需要深思**
- k0 决定了物理域大小, 变化时波数网格整体缩放
- 如果 k0 可变: PSM loss 的波数必须动态构造, grid 编码也需要调整
- **但**: k0 本质上是一个"实验设置"参数而非"物理参数"——在一次实验中 k0 是固定的
- **建议**: 初版固定 k0，模型学习一个固定域大小下的 (α, κ, ν) 参数空间
- 如果未来要泛化到不同域大小，可以将 k0 加入 MoO

### 3.3 MoO 输入维度方案对比

| 方案 | f_nu 输入 | 维度 | in_proj 拼接 | 总输入维 | 复杂度 |
|------|-----------|------|-------------|---------|--------|
| A: 最小 | [α, κ] | 2 | 场(2) + grid(2) + param(2) = 6 | 6 | 与 KSE 同 |
| B: 含 ν | [α, κ, ν] | 3 | 场(2) + grid(2) + param(3) = 7 | 7 | 稍增 |
| C: 含 ν+k0 | [α, κ, ν, k0] | 4 | 场(2) + grid(2) + param(4) = 8 | 8 | 需动态波数 |
| D: 全部含 N | [α, κ, ν, N] | 4 | 场(2) + grid(2) + param(4) = 8 | 8 | N需编码 |

---

## 4. 多场 (Multi-Field) 带来的系统性影响

KSE 是单场 PDE, HW 是双场耦合系统。这是**最根本的结构差异**，影响 pipeline 的每一个环节。

### 4.1 模型 I/O 变化

| | KSE | HW |
|---|---|---|
| 模型输入 | `[B, S, S, 1]` (u 场) | `[B, S, S, 2]` (ζ 和 n 场) |
| 训练输出 | `[B, S, S, Tp]` (Tp 帧 u) | `[B, S, S, ?]` (Tp 帧 × 2 场) |
| 推理输出 | `[B, S, S, 1]` (1 帧 u) | `[B, S, S, 2]` (1 帧 ζ+n) |
| 残差连接 | `x_o [B,S,S,1] + delta` | `x_o [B,S,S,2] + delta` |

**多帧多场输出的设计问题**: 训练模式需要输出 Tp 帧 × 2 场。有几种组织方式:

**方案 1: 交织** — 输出 `[B, S, S, 2*Tp]`，其中 `[..., 0::2]` = ζ 帧, `[..., 1::2]` = n 帧
- 优点: 与现有 Conv1d 输出头兼容（只需加倍维度）
- 缺点: 两场特征在 Conv1d 中混合，不一定合理

**方案 2: 拼接** — 输出 `[B, S, S, Tp, 2]`，即先时间再场
- 优点: 语义清晰
- 缺点: 需要重新设计 Conv1d 输出头

**方案 3: 独立输出头** — backbone 共享，两个 output head 各输出 `[B, S, S, Tp]`
- 优点: 架构最清晰，每个场有独立的时间投影
- 缺点: 参数量略增（两组 fc1a+fc1b+output_mlp）

**方案 4: 通道加倍** — 把 width 的最后维度视为 2×(width/2)，分别投影
- 复杂度过高，不推荐

### 4.2 PSM Loss 的复杂度跃升

KSE PSM: 1 个方程 → 1 个残差场 → 1 个标量 loss

HW PSM: 2 个耦合方程 → 2 个残差场 → 如何合成 1 个标量 loss?

**残差合成方式的选择**:

```python
# 方案 A: 简单求和（两方程等权）
loss = sqrt(mean(Du_zeta² + Du_n²) + eps)

# 方案 B: 分别计算后平均
loss = 0.5 * (sqrt(mean(Du_zeta²) + eps) + sqrt(mean(Du_n²) + eps))

# 方案 C: 加权（如果两方程残差量级差异大）
loss = w1 * sqrt(mean(Du_zeta²) + eps) + w2 * sqrt(mean(Du_n²) + eps)
```

**潜在问题**: ζ 方程和 n 方程的残差量级可能差异很大（ζ 有 Poisson 括号非线性, n 还有 κ·∂φ/∂y 驱动项）。如果量级差 10 倍，简单求和会导致训练被大残差方程主导。**需要在实验中观察两个残差的比例**。

### 4.3 HW PSM 中的 Poisson 括号计算

KSE 的非线性项 `|∇u|²` 在谱空间中计算简单:
```python
wx = ifft2(1j*kx*w_h).real   # 谱方法求导
wy = ifft2(1j*ky*w_h).real
N = 0.5 * param2 * fft2(wx² + wy²)
```

HW 的 Poisson 括号更复杂——涉及**两个不同场的交叉导数**:
```python
# [φ, ζ] = ∂φ/∂x · ∂ζ/∂y - ∂φ/∂y · ∂ζ/∂x
# 需要先从 ζ 求 φ (Poisson solve)，再算 4 个导数
phi_h = -zeta_h / k2_safe
dphi_dx = ifft2(1j*kx*phi_h).real
dphi_dy = ifft2(1j*ky*phi_h).real
dzeta_dx = ifft2(1j*kx*zeta_h).real
dzeta_dy = ifft2(1j*ky*zeta_h).real
pb_zeta = dphi_dx * dzeta_dy - dphi_dy * dzeta_dx
```

**计算量对比**: KSE 每帧 2 次 FFT+iFFT (wx, wy)；HW 每帧每方程需 ~6 次 FFT+iFFT (phi + 4 导数 + n 方程的导数)。**HW 的 PSM loss 计算量约为 KSE 的 3~4 倍**。

### 4.4 关键差异: PSM 用谱方法 vs Solver 用 Arakawa

HW solver 中 Poisson 括号用 **Arakawa scheme**（有限差分，保守形式，守恒能量/涡度拟能）。
PSM loss 中如果用**谱方法**计算 Poisson 括号，与 solver 在离散层面有差异。

这意味着: 即使把 solver 的精确解代入 PSM，残差也**不会严格为零**（只有在网格足够密时才趋于零）。
**这是一个必须验证的风险点**: 在目标分辨率 (如 64×64 或 128×128) 上，谱方法 Poisson 括号与 Arakawa 的差异有多大。

---

## 5. Pipeline 各模块改动分析

### 5.1 数据生成 (`data/`)

| 文件 | 改动 | 原因 |
|------|------|------|
| `kse.py` → `hw_solver.py` | **完全重写** | PDE 完全不同 |
| `sampler.py` | **需要重新设计** | HW 初值问题: 小噪声 spin-up vs GRF 大振幅 |
| `generate_data.py` | **大量修改** | 参数维度变化、数据格式变化 (双场) |
| `main.py` | **修改** | 参数范围、命名约定 |

**HW 初值的特殊问题**:

HW 从 1e-6 小噪声开始，需要很长 spin-up 时间 (~T=50~100) 才能发展到湍流平衡态。而 OmniFluids 的预训练是在线采样初值，如果用类似 KSE 的大振幅 GRF 作为初值:
- **可能可行**: 大振幅初值经过超扩散会快速衰减到合理量级
- **可能不可行**: 大振幅初值可能违反 HW 的物理约束（如 ζ = ∇²φ 关系），导致 PSM loss 初始残差极大
- **替代方案**: 预先跑一批 spin-up，存储平衡态作为"初值库"；pretrain 时从库中随机采样

**数据保存格式变化**:

```
KSE: sol [B, S, S, T+1], param [B, 2]
HW:  sol [B, S, S, T+1, 2] (或 [B, 2, S, S, T+1]), param [B, M]
     其中 M = 参数个数 (至少 3: α, κ, ν)
```

### 5.2 PSM Loss (`pretrain/psm_loss.py`)

**完全重写**。这是物理核心，也是最容易出错的地方。

需要实现的计算链路 (每帧):

```
输入: ζ[t], n[t]  (物理空间)
  ↓ fft2
ζ_h, n_h  (频域)
  ↓ Poisson solve
φ_h = -ζ_h / k²  (频域, k²[0,0]=1 防除零, φ_h[0,0]=0 零均值)
  ↓ 谱导数 (共 6 次 ifft2)
∂φ/∂x, ∂φ/∂y, ∂ζ/∂x, ∂ζ/∂y, ∂n/∂x, ∂n/∂y  (物理空间)
  ↓ Poisson 括号 (物理空间乘法)
[φ, ζ] = ∂φ/∂x·∂ζ/∂y - ∂φ/∂y·∂ζ/∂x
[φ, n] = ∂φ/∂x·∂n/∂y - ∂φ/∂y·∂n/∂x
  ↓ 其他项
φ = ifft2(φ_h)   (需要物理空间的 φ)
coupling = α·(φ - n)
gradient_drive = -κ·∂φ/∂y
diff_ζ = ifft2(-ν·k^{2N}·ζ_h)
diff_n = ifft2(-ν·k^{2N}·n_h)
  ↓ 空间算子组装
F_ζ = -[φ, ζ] + coupling + diff_ζ
F_n = -[φ, n] + gradient_drive + coupling + diff_n
  ↓ CN 时间离散 (与 KSE 相同)
wt_ζ = (ζ[t+1] - ζ[t]) / dt
Du_ζ = wt_ζ + 0.5·(F_ζ[t] + F_ζ[t+1])
Du_n 同理
```

**波数构造的关键决策**:

PSM 中的波数必须与 solver 的物理域一致。如果 k0 作为可变参数:
```python
L = 2*pi/k0
dx = L/S
kx = fftfreq(S, d=dx/(2*pi))  # 每个样本的 k0 不同 → kx 不同!
```
这意味着 **batch 内每个样本的波数网格不同**——批量 FFT 后的频域操作需要逐样本处理，极大增加复杂度。
→ **强烈建议初版固定 k0**。

### 5.3 模型架构 (`pretrain/model.py`)

#### 5.3.1 in_proj 输入

```
KSE:  [u(1), grid_x(1), grid_y(1), param1(1), param2(1)] = 5 维
NSE:  [w(1), grid_x(1), grid_y(1), forcing(1), nu(1)]     = 5 维
HW:   [ζ(1), n(1), grid_x(1), grid_y(1), α(1), κ(1), ν(1)] = 7 维 (方案 B)
```

in_proj: `Linear(7 → width)` (如果包含 α, κ, ν)

#### 5.3.2 f_nu 专家路由 MLP

```
KSE: Linear(2 → 128) → GELU → Linear(128 → 128) → GELU → Linear(128 → K)
     输入: [param1, param2]

NSE: Linear(1 → 128) → ...
     输入: [nu]

HW:  Linear(M → 128) → GELU → Linear(128 → 128) → GELU → Linear(128 → K)
     输入: [α, κ, ν]  (M=3)
     或:   [α, κ, log10(ν)]  (对 ν 做 log 变换以平衡量级)
```

**ν 的尺度问题**: ν ∈ [1e-6, 1e-3]，跨 3 个数量级。直接输入 MLP 会导致:
- 不同量级的 ν 在 MLP 中的影响差异极大
- 建议参照 NSE 的处理: 存储 `log10(ν)` (范围 [-6, -3])，MLP 输入用 log 尺度

**α 和 κ 的尺度**: α ∈ [0.01, 10], κ ∈ [0.1, 5]，范围中等，可以直接输入或做 log。

#### 5.3.3 param 的空间广播

KSE 的 param 是 `[B, 2]` 标量，通过 `reshape(B,1,1,2).repeat(1,S,S,1)` 广播到每个空间点。
NSE 的 param 是 `[B, S, S, 2]`，其中 forcing 是空间变化的场, nu 是广播标量。

HW 的所有参数 (α, κ, ν) 都是**全局标量**，没有空间变化的 forcing。
→ 处理方式与 KSE 相同: `param.reshape(B,1,1,M).repeat(1,S,S,1)`

#### 5.3.4 输出头与多场问题

这是最复杂的设计决策，见 4.1 节。核心问题:

- backbone (SpectralConv2d_dy 层) 是否需要改动？**不需要**——backbone 处理的是 `[B, S, S, width]` 的隐空间特征，与输入/输出场数无关
- 输出头如何处理两个场？见 4.1 节方案 1~3

#### 5.3.5 get_grid 位置编码

目前生成 `[0, 2π)` 归一化坐标。对于 HW 域 `[0, L)`:
- 如果 k0 固定: 保持 `[0, 2π)` 作为归一化位置编码即可
- 如果 k0 可变: 仍可用 `[0, 2π)` (网络自己学会适配)，或改为 `[0, L)` (但 L 每个样本不同时不好处理)

### 5.4 训练循环 (`pretrain/train.py`)

**在线采样**:

```python
# KSE
w0 = GRF(B)[..., None]           # [B, S, S, 1]
param[:, 0] ~ U(param1_range)     # 线性系数
param[:, 1] ~ U(param2_range)     # 非线性系数

# HW
zeta0 = ???                        # [B, S, S, 1]  涡度初值
n0 = ???                           # [B, S, S, 1]  密度初值
w0 = cat(zeta0, n0, dim=-1)       # [B, S, S, 2]
param[:, 0] ~ U(alpha_range)      # 耦合强度
param[:, 1] ~ U(kappa_range)      # 密度梯度
param[:, 2] ~ LogU(nu_range)      # 超黏性 (log 均匀采样)
```

**HW 初值采样是最大的开放问题**: 参见 5.1 节讨论。

**模型输出 → PSM loss 的数据流**:

```python
# KSE
w_pred = net(w0, param)                # [B, S, S, Tp]
w_all = cat([w0, w_pred], dim=-1)      # [B, S, S, Tp+1]
loss = PSM_loss(w_all, param, rollout_DT, 'cn')

# HW (需要重新组织)
w_pred = net(w0, param)                # [B, S, S, ???]  多场多帧
# 如何从 w_pred 分离出 ζ 和 n 的 Tp 帧?
# 然后 cat 初值, 传入 PSM_HW
```

这里的数据组织方式取决于输出头设计（方案 1/2/3），尚未确定。

**val 函数**: 需要用 HW PSM loss 替代 KSE PSM loss。

**test 函数**: rollout 时每步输出 `[B,S,S,2]` (ζ+n)，与数据对齐后计算两场的相对 L2 误差。

### 5.5 蒸馏 (`distillation/`)

**改动相对最小**: 蒸馏不涉及 PDE 物理（只是学生拟合教师输出）。

需要改的:
- model.py: 与 pretrain/model.py 同步改动 (in_proj, f_nu, 输出头)
- train.py: 在线采样改为 HW 式 (双场初值 + 3 参数)；教师 rollout 输出 `[B,S,S,2]`；空间下采样对两场同时做
- Student2D 输出头: `Linear(width → 4*width) → GELU → Linear(4*width → 2)` (输出 2 场)

### 5.6 微调 (`finetune/`)

**改动**:
- 数据加载: 真实轨迹 `[N, S, S, T+1, 2]`
- 随机时间采样: 取 `(t, t+step, t+2*step)` 三帧，每帧包含 (ζ, n)
- Loss: RMSE 对两场同时计算 (或分别加权)

---

## 6. 需要深度思考的开放问题

### 6.1 初值采样策略

KSE 的 GRF 初值振幅 O(1)，与湍流态量级接近，可以直接用于 pretrain。
HW 的湍流态需要从 1e-6 小扰动 spin-up 数十秒才能达到，直接用 GRF 大振幅初值:

- **可能性 1**: HW 方程足够耗散（ν·k^6 项），大振幅初值迅速衰减到合理范围，pretrain 可以工作
- **可能性 2**: 大振幅初值严重违反 ζ = ∇²φ 的物理约束（GRF 生成的 ζ 和 n 是独立的，不满足任何物理关系），导致 PSM 残差极大且梯度混乱
- **可能性 3**: 需要"受约束的初值采样"——如先生成 φ 的 GRF，再算 ζ = ∇²φ，n 取 φ 的某个变换

**这需要实验验证。**

### 6.2 ν 跨量级时 PSM 的数值问题

超扩散项 `ν·k^{2N}` 在 N=3 时是 `ν·k^6`。如果 S=128, 最大波数 k_max ≈ S/2·k0 ≈ 9.6:
- k_max^6 ≈ 8e5
- ν=1e-3 时: ν·k_max^6 ≈ 800
- ν=1e-6 时: ν·k_max^6 ≈ 0.8

不同 ν 下耗散项贡献差 1000 倍！在同一个 PSM loss 中混合不同 ν 的样本，可能导致:
- 高 ν 样本的残差被耗散项主导
- 低 ν 样本的残差被非线性项主导
- 网络难以同时学好两个 regime

**可能的缓解**: 对 PSM loss 做 per-sample 归一化，或按 ν 范围分段训练。

### 6.3 两方程残差的平衡

ζ 方程的主要项是 Poisson 括号（非线性对流），n 方程额外有 κ·∂φ/∂y 驱动项。
两方程残差的量级可能系统性不同。如果 `Du_n >> Du_ζ`，简单求和会使训练偏向最小化 n 方程残差。

**需要在实验中监控两个残差的比例**，必要时引入自适应权重。

### 6.4 Arakawa vs 谱方法 Poisson 括号的一致性

Solver 用 Arakawa scheme（二阶有限差分），PSM 用谱方法。
在粗网格 (64×64) 上，两种方法的差异可能非平凡:
- Arakawa 在高波数处有色散误差
- 谱方法无色散误差但有 Gibbs 现象

**必须用数值实验量化**: 对 solver 精确轨迹，计算 PSM(谱) 残差，看是否足够小。

### 6.5 训练/推理时间成本

HW 的 PSM loss 计算量约为 KSE 的 3~4 倍 (更多 FFT 操作)。加上双场输出:
- 预训练每步时间可能是 KSE 的 4~5 倍
- 可能需要减小 batch_size 或 output_dim 来适配 GPU 显存

---

## 7. 总结: 改动规模一览

| 模块 | 改动量级 | 核心难点 |
|------|---------|---------|
| `data/solver` | 完全重写 | HW solver 已有,需封装接口 |
| `data/sampler` | 重新设计 | 初值采样策略是开放问题 |
| `data/generate_data` | 大幅修改 | 双场格式、多参数 |
| `pretrain/psm_loss` | **完全重写** | Poisson 括号、双残差、波数构造 |
| `pretrain/model` | 中等修改 | in_proj(6→7维)、f_nu(2→3维)、输出头(双场) |
| `pretrain/train` | 中等修改 | 在线采样、PSM 调用、test rollout |
| `distillation/*` | 小幅修改 | 同步 model 改动、双场下采样 |
| `finetune/*` | 小幅修改 | 数据格式、双场 loss |
| `tools.py` (各阶段) | 小幅修改 | GRF 参数、param_flops |

**风险排序 (从高到低)**:
1. PSM loss 正确性（波数、Poisson 括号、双残差平衡）
2. 初值采样策略（大振幅 GRF vs 平衡态库）
3. ν 跨量级时的训练稳定性
4. 多场输出头设计的效果
5. Arakawa vs 谱方法的一致性
